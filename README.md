# MPCC for manipulator
This code run at ROS1 noetic with Ubuntu 20.04.

## Installation guide
### C++ dependency
Install C++ dependencies and build
```sh
git clone https://github.com/JunHeonYoon/MPCC_manipulator.git
cd MPCC_manipulator/cpp
./install.sh

mkdir build && cd build
cmake ..
make -j8
```

If your cmake version lower than 3.18, than update cmake
```sh
# Download new version of cmake at https://cmake.org/download/
cd path/to/cmake/folder

make -j30 && sudo make install

echo 'export PATH=$HOME/cmake-install/bin:$PATH' >> ~/.bashrc
echo 'export CMAKE_PREFIX_PATH=$HOME/cmake-install:$CMAKE_PREFIX_PATH' >> ~/.bashrc

source ~/.bashrc
```

Check if install was done successfully
```sh
cd build
./MPCC_TEST
```

### Python dependency
1. [MoveIt](https://moveit.ai/)
```sh
sudo apt install ros-$ROS_DISTRO-moveit
```
2. [Franka description](https://github.com/frankaemika/franka_ros/tree/develop/franka_description)
```sh
sudo apt install ros-$ROS_DISTRO-franka-ros
```
3. [Husky description](https://github.com/husky/husky/tree/noetic-devel/husky_description)
```sh
sudo apt install ros-$ROS_DISTRO-husky-desktop
```
4. [suhan_robot_model_tools](https://github.com/psh117/suhan_robot_model_tools)
```sh
sudo apt install ros-$ROS_DISTRO-combined-robot-hw ros-$ROS_DISTRO-trac-ik ros-$ROS_DISTRO-nlopt
sudo apt install libnlopt-dev libnlopt-cxx-dev libglfw3-dev

pip install tqdm matplotlib
```
```sh
cd ~/catkin_ws/src/

git clone https://github.com/psh117/gl_depth_sim
git clone https://github.com/psh117/suhan_robot_model_tools.git

cd .. && catkin build

source devel/setup.bash
```
5. [husky_panda](https://github.com/JunHeonYoon/husky_panda)
```sh
cd ~/catkin_ws/src/

git clone https://github.com/JunHeonYoon/husky_panda.git

cd .. && catkin build

source ../devel/setup.bash
```
## Running MPCC with Python
Robot visualize setup
```sh
roslaunch husky_panda_moveit_config vis.launch
```

Running MPCC
```sh
cd MPCC_manipulator/python
python3 main_w_sim.py
```

## User parameter
Users can modify parameters and path in [Params](https://github.com/JunHeonYoon/MPCC_manipulator/tree/master/cpp/Params)

### [bounds](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/bounds.json)
Upper, lower bound for state and input
- joint angle(q)
- joint velocity(qdot)
- joint acceleration(qddot)
- path parameter(s)
- velocity of s(vs)
- acceleration of s(dVs) 

### [config](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/config.json)
- n_sim: Limit for simulation [tick]
- Ts: Sampling time for MPCC [sec]

### [cost](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/cost.json)
Weighing scalar paramters
- qC: Contouring error cost
- qCNmult: Multiplication factor for terminal consouring error cost
- qL: Lag error cost
- qVs: Velocity of path parameter error cost
- qOri: Orientation error cost
- qSing: Singularity maximazation cost
- rdq: Joint velocity regularization cost
- rddq: Change of joint velocity regularization cost
- rdVs: Acceleration of path parameter regularization cost

### [model](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/model.json)
MPCC model parameters
- max_dist_proj:
- desired_ee_velocity: desired velocity for path parameter
- s_trust_region:
- deaccelerate_ratio:
- tol_sing: tolerence for singularity avoidance constraint
- tol_selcol: tolerence for self-collision avoidance constraint
- tol_envcol: tolerence for environment-collision avoidance constraint
 
### [noramalization](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/normalization.json)
Normalization for state and control input setting QP
  
### [sqp](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/sqp.json)
  
### [track](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/track.json)
Reference path for MPCC.
This can be generated by using [track.py](https://github.com/JunHeonYoon/MPCC_manipulator/blob/master/cpp/Params/track.py)
